<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="Icono minimalista es.png">
  <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login Choferes</title>
    <style>
       html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  font-family: 'Segoe UI', Arial, sans-serif;
  background: linear-gradient(135deg, #020003, #e0f7fa);
  justify-content: center;
  align-items: center;
  display: flex;
  flex-direction: column;
  
}

.container {
  width: 90%;
  height: 90%;
  
  margin-left: 5px;
  margin-right: 5px;
  display: flex;
  flex-direction: column; /* apila elementos verticalmente */
  justify-content: center;
  align-items: center;
  margin-top: 0px;
  padding-top: 0px;
  background: white;
  box-sizing: border-box;
  /*padding: 20px;*/
  border-radius: 10px;
}


   h1, h2 {
  color: #6a5acd;
  margin-bottom: 15px;
  font-size: 1.4em;
}


    input, button {
  width: 100%; /* que ocupen todo el ancho en móviles */
  box-sizing: border-box;
}


    button {
      background: #6a5acd;
      color: white;
      border: none;
      padding: 12px 20px;
      margin-top: 15px;
      border-radius: 8px;
      font-size: 15px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #836fff;
    }
    #pernocteActivo {
      background: #f0f8ff;
      border: 2px dashed #6a5acd;
      border-radius: 10px;
      padding: 15px;
      margin-top: 20px;
    }
    ul {
      text-align: left;
      padding-left: 20px;
      font-size: 14px;
      color: #333;
    }
    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(20px);}
      to {opacity: 1; transform: translateY(0);}
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(106,90,205, 0.4); }
      70% { box-shadow: 0 0 0 20px rgba(106,90,205, 0); }
      100% { box-shadow: 0 0 0 0 rgba(106,90,205, 0); }
    }
    .badge {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  background: #f0f8ff;
  border: 4px solid #6a5acd;
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 0 auto 15px auto;
  font-size: 1em;
  font-weight: bold;
  color: #333;
  animation: pulse 2s infinite;
}

/* Media queries para pantallas pequeñas */
@media (max-width: 480px) {
  h1, h2 {
    font-size: 1.2em;
  }
  .badge {
    width: 80px;
    height: 80px;
    font-size: 0.9em;
  }
  button {
    font-size: 0.9em;
    padding: 10px;
  }
}

.alinear-arriba {
    vertical-align: top;
}








  </style>








</head>
<body>
  <nav>soy ..............</nav>
<div class="container" style="justify-content: start;">
  <h2 >
  <img src="Icono minimalista es.png" width="32" height="32" >
  PernoctaApp Registros TMS </h2>
  

   <br>

  <!-- Cargando -->
  <div id="loading" style="display:none;">Validando sesión...</div>
  
    

  <!-- Login -->
  <div id="loginForm" style="display:none; ">
    <h1 >Login Choferes</h1>
    <input type="text" id="usuario" placeholder="Usuario" style="font: 1em sans-serif;border-radius: 7px;"><br><br>
    <input type="password" id="password" placeholder="Contraseña" style="font:1em sans-serif ;border-radius: 7px"><br><br>
    <button id="btnIngresar" onclick="login()">Ingresar</button>
  </div>

  <!-- Bienvenida -->
  <div id="bienvenida" style="display:none;">
    <h2>Bienvenido, <span id="nombreUsuario"></span></h2>
    <button onclick="logout()">Cerrar sesión</button>
  </div>

  <!-- Main y pernocte -->
  <div id="mainScreen" style="display:none;">
    <h3>Pantalla principal</h3>
    <button id="btnIniciar" onclick="iniciarPernocte()">Iniciar Pernocte</button>
  </div>

  <div id="pernocteActivo" style="display:none;">
    <!--h3>Pernocte en curso...</h3-->
    <div class="badge" id="contador">0h 0m 0s</div>

    <p>Inicio: <span id="inicioPernocte"></span></p>
    <button id="btn_enviar"onclick="finalizarPernocte()">Finalizar Pernocte</button>
    <p>Tiempo en pernocte: <span id="contador"></span></p>

  </div>
  
    <div id="resumen" style="display: none;">
        <h3>Resumen de Pernoctes</h3>
        <ul id="listaResumen"></ul>
    </div>



  <script>
    const endpoint = "https://script.google.com/macros/s/AKfycbwhFD9C_jar4k4H7m2PIt_3HAXuPKQ71r2eOHn_Vls8ueSYVBxvaBaq44M0cZc6_nAC/exec"; // URL del Apps Script
   
    
    
    let intervalo;
    // onload ASÍNCRONO: espera validación antes de dibujar UI
    window.onload = async function() {
      const usuarioGuardado = localStorage.getItem("usuario");
      const passwordGuardado = localStorage.getItem("password");
      const inicioPernocte = localStorage.getItem("inicioPernocte");
     // document.getElementById("loginForm").style.display = "none";
     //  mostrarResumen();
      if (usuarioGuardado && passwordGuardado) {
        mostrarLoading(true);
        const valido = await validarUsuario(usuarioGuardado, passwordGuardado);
        mostrarResumen();
        mostrarLoading(false);

        if (valido) {
          mostrarBienvenida(usuarioGuardado);
          mostrarResumen();
          document.getElementById("resumen").style.display = "block";
          if (inicioPernocte) {
            mostrarPernocteActivo(inicioPernocte);
           
          } else {
            document.getElementById("mainScreen").style.display = "block";
            mostrarResumen();
          }
        } else {
          // sesión inválida: limpiar y mostrar login
          logout(false);
          //document.getElementById("loginForm").style.display = "block"
          alert("Tu usuario ya no está activo o credenciales cambiaron.");
        }
      }else {
        document.getElementById("loginForm").style.display = "block";
      }
    };

    async function login() {
      const btn = document.getElementById("btnIngresar");
      const usuario = document.getElementById("usuario").value.trim();
      const password = document.getElementById("password").value.trim();
      

      if (!usuario || !password) {
        alert("Ingresa usuario y contraseña");
        return;
      }

      btn.disabled = true;
      mostrarLoading(true);

      const valido = await validarUsuario(usuario, password);

      mostrarLoading(false);
      btn.disabled = false;

      if (valido) {
        localStorage.setItem("usuario", usuario);
        localStorage.setItem("password", password); // MVP
        mostrarBienvenida(usuario);
        mostrarMain();
        mostrarResumen();
        const inicioPernocte = localStorage.getItem("inicioPernocte");
        if (inicioPernocte) {
          mostrarPernocteActivo(inicioPernocte);
        } else {
          
          
        }
      } else {
        alert("Usuario o contraseña inválidos, o usuario inactivo.");
      }
    }

    async function validarUsuario(usuario, password) {
      try {
        const res = await fetch(endpoint+ "?tipo=usuarios");
        const data = await res.json();
        const chofer = data.find(c => String(c.usuario) === usuario && String(c.password) === password);
        //mostrarMain()
        return !!(chofer && String(chofer.activo).toUpperCase() === "SI");
      } catch (err) {
        console.error("Error validando usuario:", err);
        document.getElementById("loginForm").style.display = "none";
        return false;
      }
    }

    // UI helpers
    function mostrarLoading(show) {
      document.getElementById("loading").style.display = show ? "block" : "none";
    }

    function mostrarBienvenida(usuario) {
      document.getElementById("loginForm").style.display = "none";
      document.getElementById("bienvenida").style.display = "block";
      document.getElementById("resumen").style.display = "block";
      document.getElementById("nombreUsuario").textContent = usuario;
      //mostrarResumen();
    }

    function mostrarMain() {
      document.getElementById("mainScreen").style.display = "block";
    }

    function logout(showLogin = true) {
      localStorage.removeItem("usuario");
      localStorage.removeItem("password");
      document.getElementById("resumen").style.display = "none";
      // No borrar inicioPernocte para no perder estado si fue intencional
      document.getElementById("bienvenida").style.display = "none";
      if (showLogin) {document.getElementById("loginForm").style.display = "block";
      document.getElementById("mainScreen").style.display = "none";
      document.getElementById("pernocteActivo").style.display = "none";}
    }

    // Pernocte
    
   
    function mostrarPernocteActivo(inicioISO) {
      document.getElementById("mainScreen").style.display = "none";
      document.getElementById("pernocteActivo").style.display = "block";
      
      const inicio = new Date(inicioISO).toLocaleString();
      document.getElementById("inicioPernocte").textContent = inicio;
    }

   function iniciarPernocte() {
      const inicio = new Date();
      localStorage.setItem("inicioPernocte", inicio.toISOString());
      document.getElementById("inicioPernocte").textContent = inicio.toLocaleString();
      document.getElementById("mainScreen").style.display = "none";
      document.getElementById("pernocteActivo").style.display = "block";

      
        iniciarContador(inicio);
    }



    async function finalizarPernocte() {
      const inicioISO = localStorage.getItem("inicioPernocte");
      document.getElementById("btn_enviar").disabled = true;
      //const finISO = new Date().toISOString();
      const inicioL = new Date(inicioISO);
      const inicio= new Date(inicioL.setHours(inicioL.getHours() - 3));
      const final = new Date();
      
      const fin= new Date( final.setHours(final.getHours() - 3));








      const duracionMs = new Date(fin) - new Date(inicio);
      const horas = Math.floor(duracionMs / 3600000);
      const minutos = Math.floor((duracionMs % 3600000) / 60000);
      const duracion = `${horas}h ${minutos}m`;

      const registro = {
        usuario: localStorage.getItem("usuario"),
        //inicio: new Date(inicioISO).toLocaleString(),
        inicio: inicio.toISOString(),
        fin: fin.toISOString(),
       // fin: new Date(finISO).toLocaleString(),
        duracion
      };

      try {
        const res = await fetch(endpoint, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(registro)
        });
        //const data = await res.json();
       // console.log("Respuesta del servidor:", data);
        alert("Pernocte finalizado y enviado.");
        document.getElementById("btn_enviar").disabled = false;
      } catch (err) {
        console.error("Error enviando pernocte:", err);
        alert("No se pudo enviar. Queda activo hasta nuevo intento.");
        return; // no limpiar estado si falla envío
      }

      localStorage.removeItem("inicioPernocte");
      document.getElementById("pernocteActivo").style.display = "none";
      document.getElementById("mainScreen").style.display = "block";
      mostrarResumen();
    }
    
 
    
//const endpoint = "https://script.google.com/macros/s/AKfycbwhFD9C_jar4k4H7m2PIt_3HAXuPKQ71r2eOHn_Vls8ueSYVBxvaBaq44M0cZc6_nAC/exec"; // URL del Apps Script
   
async function mostrarResumen() {
  try {
    const usuarioActivo = localStorage.getItem("usuario");
    const res = await fetch(endpoint + "?tipo=pernoctes");
    const data = await res.json();
    const registrosUsuario = data.filter(item => item.usuario === usuarioActivo);



    // Agrupar por mes
    const resumen = {};
    registrosUsuario.forEach(item => {
      const fecha = new Date(item.inicio);
      const mes = fecha.toLocaleString("es-ES", { month: "long", year: "numeric" });
      resumen[mes] = (resumen[mes] || 0) + 1;
    });

    // Mostrar en pantalla
    const lista = document.getElementById("listaResumen");
    lista.innerHTML = "";
    for (const mes in resumen) {
      const li = document.createElement("li");
      li.textContent = `${mes}: ${resumen[mes]} pernoctes`;
      lista.appendChild(li);
    }
  } catch (err) {
    console.error("Error obteniendo resumen:", err);
  }
}

function iniciarContador(inicio) {
  clearInterval(intervalo);
  intervalo = setInterval(() => {
    const ahora = new Date();
    const diff = Math.floor((ahora - inicio) / 1000);
    const horas = Math.floor(diff / 3600);
    const minutos = Math.floor((diff % 3600) / 60);
    const segundos = diff % 60;
    document.getElementById("contador").textContent =
      `${horas}h ${minutos}m ${segundos}s`;
  }, 1000);
}

// Al cargar la página, verificar si hay pernocte activo





window.addEventListener("load", () => {
  const inicioISO = localStorage.getItem("inicioPernocte");
  const usuarioG = localStorage.getItem("usuario");
  if (inicioISO && usuarioG) {
    const inicio = new Date(inicioISO);
    document.getElementById("mainScreen").style.display = "none";
    document.getElementById("pernocteActivo").style.display = "block";
    document.getElementById("inicioPernocte").textContent = inicio.toLocaleString();
    document.getElementById("loginForm").style.display = "none";
    iniciarContador(inicio); // retoma el contador desde el inicio guardado
  }else if (!usuarioG && inicioISO) {
    document.getElementById("loginForm").style.display = "block";
    const inicio = new Date(inicioISO);
    iniciarContador(inicio);
    //mostrarResumen();
  } else {
    // si no hay pernocte activo, mostrar pantalla principal
    document.getElementById("mainScreen").style.display = "none";
    document.getElementById("pernocteActivo").style.display = "none";
  }
});


</script>


</div>
</body>
</html>